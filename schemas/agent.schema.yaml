# Agent module schema for agent.yaml validation
type: object
required: [meta, identity, powers, constraints]
properties:
  meta:
    type: object
    required: [name, description, version]
    properties:
      name: 
        type: string
        pattern: "^[a-zA-Z0-9_-]+$"
        description: "Agent identifier (letters, numbers, hyphens, underscores only)"
      description: 
        type: string
        minLength: 10
        maxLength: 500
        description: "Agent description"
      version: 
        type: string
        pattern: "^\\d+\\.\\d+\\.\\d+$"
        description: "Semantic version (MAJOR.MINOR.PATCH)"
      author: 
        type: string
        description: "Agent author"
        
  identity:
    type: object
    required: [prompt_file]
    properties:
      prompt_file: 
        type: string
        pattern: "\\.md$"
        description: "System prompt markdown file"
      expertise: 
        type: array
        items:
          type: string
        description: "Areas of expertise"
          
  powers:
    type: array
    minItems: 1
    items:
      oneOf:
        - type: string
          pattern: "^\\./.*"
          description: "Simple power path reference"
        - type: object
          required: [path]
          properties:
            path:
              type: string
              pattern: "^\\./.*"
              description: "Power directory path"
            exclude_tools:
              type: array
              items:
                type: string
              description: "Tools to exclude from this power"
            tool_aliases:
              type: object
              additionalProperties:
                type: string
              description: "Tool name aliases to resolve collisions"
            server_aliases:
              type: object
              additionalProperties:
                type: string
              description: "MCP server name aliases to resolve collisions"
            exclude_steering_sections:
              type: array
              items:
                type: string
              description: "Steering sections to exclude"
      
  constraints:
    type: object
    properties:
      allowed_tools:
        type: array
        items:
          type: string
          pattern: "^[a-zA-Z0-9_.*-]+$"
        description: "Tools that can be used without prompting"
      denied_tools:
        type: array
        items:
          type: string
        description: "Tools to deny/disable"
      requires_network:
        type: boolean
        default: false
        description: "Whether agent requires network access"
      opt_out_collection_constraints:
        type: boolean
        default: false
        description: "Opt out of collection-level constraints"
      opt_out_justification:
        type: string
        description: "Required justification when opting out of collection constraints"
        
  subagents:
    type: object
    properties:
      allowed_specialists:
        type: array
        items:
          type: string
          pattern: "^[a-zA-Z0-9_-]+$"
        description: "Subagent module names that can be delegated to"
      max_concurrent:
        type: integer
        minimum: 1
        maximum: 10
        default: 3
        description: "Maximum concurrent subagent delegations"
      delegation_rules:
        type: array
        items:
          type: string
        description: "Human-readable delegation rules"
      delegation_security:
        type: object
        properties:
          constraint_intersection:
            type: boolean
            default: true
            description: "Subagents inherit delegator's constraints (secure default)"
          audit_trail:
            type: boolean
            default: true
            description: "Log all delegation requests with context"
          require_justification:
            type: boolean
            default: false
            description: "Require explanation for each delegation"
          allow_full_delegation:
            type: boolean
            default: false
            description: "Allow subagent to use full permissions (requires justification)"
          justification:
            type: string
            description: "Required when allow_full_delegation: true or constraint_intersection: false"
          allowed_elevations:
            type: array
            items:
              type: object
              required: [tool_pattern, justification]
              properties:
                tool_pattern:
                  type: string
                  description: "Tool pattern subagent can use beyond delegator's permissions"
                justification:
                  type: string
                  description: "Why this elevation is needed"
                audit_level:
                  enum: ["low", "medium", "high"]
                  default: "medium"
                  description: "Audit logging level for this elevation"
        description: "Delegation security configuration"
        
  tests:
    type: object
    properties:
      test_path:
        type: string
        default: "tests/"
        description: "Path to test directory"
      expected_behaviors:
        type: array
        minItems: 1
        items:
          type: string
        description: "Expected agent behaviors for testing"
        
  compatibility:
    type: object
    properties:
      kiro_version:
        type: string
        pattern: "^>=\\d+\\.\\d+$"
        description: "Minimum Kiro version requirement"
      platforms:
        type: array
        items:
          enum: ["darwin", "linux", "windows"]
        description: "Supported platforms"

# Validation rules (enforced by Pydantic validators):
# - opt_out_justification required when opt_out_collection_constraints is true
# - constraint_intersection: false requires either allow_full_delegation: true + justification or non-empty allowed_elevations
# - Tool patterns cannot be "*" (too broad)
# - Specialist names must be valid module names